<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤åå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{background:#f5f7fa;color:#333;line-height:1.6}
        .admin-container{max-width:1400px;margin:0 auto;padding:20px}
        .admin-header{background:white;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
        .admin-header h1{color:#4a6ee0;font-size:1.8rem;display:flex;align-items:center;gap:10px}
        .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
        .stat-card{background:white;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);text-align:center;transition:transform 0.3s,box-shadow 0.3s}
        .stat-card:hover{transform:translateY(-5px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .stat-number{font-size:2.5rem;font-weight:bold;color:#4a6ee0;margin-bottom:5px}
        .stat-label{color:#666;font-size:0.9rem}
        .tabs{display:flex;background:white;border-radius:10px 10px 0 0;overflow:hidden;margin-top:30px;flex-wrap:wrap}
        .tab{padding:15px 20px;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.3s}
        .tab.active{border-bottom:2px solid #4a6ee0;color:#4a6ee0;font-weight:600}
        .tab-content{display:none;background:white;border-radius:0 0 10px 10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
        .tab-content.active{display:block}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px 15px;text-align:left;border-bottom:1px solid #eee}
        th{background:#f8f9fa;font-weight:600;color:#555;position:relative;cursor:pointer;user-select:none}
        th:hover{background:#f0f2f5}
        .sortable::after{content:'â†•';margin-left:5px;font-size:12px;opacity:0.5}
        .sortable.asc::after{content:'â†‘';opacity:1}
        .sortable.desc::after{content:'â†“';opacity:1}
        tr:hover{background:#f8f9fa}
        .action-btn{padding:5px 10px;background:#4a6ee0;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-right:5px;transition:background 0.3s}
        .action-btn:hover{background:#3a5ed0}
        .action-btn.edit{background:#3498db}
        .action-btn.edit:hover{background:#2980b9}
        .action-btn.delete{background:#e74c3c}
        .action-btn.delete:hover{background:#c0392b}
        .search-container{margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap}
        .search-input{flex:1;min-width:200px;padding:10px 15px;border:1px solid #ddd;border-radius:6px;font-size:1rem}
        .search-btn{padding:10px 20px;background:#4a6ee0;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s}
        .search-btn:hover{background:#3a5ed0}
        .pagination{display:flex;justify-content:center;margin-top:20px;gap:5px}
        .page-btn{padding:8px 12px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;transition:all 0.3s}
        .page-btn:hover{background:#f0f0f0}
        .page-btn.active{background:#4a6ee0;color:white;border-color:#4a6ee0}
        .loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px}
        .loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #4a6ee0;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .connection-status{display:flex;align-items:center;gap:5px;font-size:0.9rem;color:#666}
        .status-dot{width:10px;height:10px;border-radius:50%;background:#4CAF50}
        .status-dot.offline{background:#f44336}
        .no-data{text-align:center;padding:30px;color:#666}
        .refresh-btn{padding:10px 20px;background:#4a6ee0;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:5px;transition:background 0.3s}
        .refresh-btn:hover{background:#3a5ed0}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal-overlay.show{opacity:1;visibility:visible}
        .modal{background:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);width:90%;max-width:800px;max-height:90vh;transform:translateY(-20px);transition:transform 0.3s;display:flex;flex-direction:column}
        .modal-overlay.show .modal{transform:translateY(0)}
        .modal-header{padding:20px 25px 10px;font-weight:600;font-size:1.2rem;color:#333;border-bottom:1px solid #eee}
        .modal-body{padding:20px 25px;color:#666;line-height:1.5;overflow-y:auto;flex:1}
        .modal-footer{padding:15px 25px 20px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #eee}
        .modal-btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s}
        .modal-btn.cancel{background:#f0f0f0;color:#333}
        .modal-btn.cancel:hover{background:#e0e0e0}
        .modal-btn.confirm{background:#4a6ee0;color:white}
        .modal-btn.confirm:hover{background:#3a5ed0}
        .form-group{margin-bottom:15px}
        .form-label{display:block;margin-bottom:5px;font-weight:500;color:#333}
        .form-input{width:100%;padding:10px 15px;border:1px solid #ddd;border-radius:6px;font-size:1rem}
        .user-avatar{width:30px;height:30px;border-radius:50%;background:#4a6ee0;display:inline-flex;align-items:center;justify-content:center;color:white;font-weight:bold;margin-right:8px}
        .user-avatar-img{width:30px;height:30px;border-radius:50%;object-fit:cover;margin-right:8px;border:1px solid #ddd}
        .user-info{display:flex;align-items:center}
        .avatar-preview{display:flex;align-items:center;gap:15px;margin-top:10px;padding:10px;background:#f8f9fa;border-radius:8px}
        .avatar-preview-img{width:50px;height:50px;border-radius:50%;background:#4a6ee0;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;background-size:cover;background-position:center;border:2px solid #ddd}
        .avatar-preview-text{font-size:0.9rem;color:#666}
        .fixed-message{max-width:400px;min-height:60px;max-height:200px;overflow-y:auto;word-wrap:break-word}
        .message-content{padding:8px 12px;border-radius:12px;background:#f0f2f5;margin-bottom:5px}
        .message.sent .message-content{background:#4a6ee0;color:white}
        .message-image{max-width:100%;max-height:150px;border-radius:8px;margin:5px 0}
        .batch-actions{display:flex;gap:10px;margin-bottom:15px;align-items:center;flex-wrap:wrap}
        .batch-action-btn{padding:8px 16px;background:#4a6ee0;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.9rem;transition:background 0.3s}
        .batch-action-btn:hover{background:#3a5ed0}
        .batch-action-btn.delete{background:#e74c3c}
        .batch-action-btn.delete:hover{background:#c0392b}
        .batch-action-btn:disabled{background:#ccc;cursor:not-allowed}
        .selected-count{color:#4a6ee0;font-weight:500;margin-left:10px}
        .checkbox-cell{width:40px;text-align:center}
        .checkbox-cell input[type="checkbox"]{width:16px;height:16px;cursor:pointer}
        .network-graph-container{width:100%;height:700px;border:1px solid #eee;border-radius:8px;position:relative;overflow:hidden;background:#fafafa}
        .graph-tooltip{position:absolute;padding:10px;background:rgba(0,0,0,0.8);color:white;border-radius:4px;pointer-events:none;font-size:0.9rem;z-index:100;max-width:300px}
        .graph-node{cursor:pointer}
        .graph-node:hover{stroke:#333;stroke-width:2px}
        .graph-node.highlighted{stroke:#4a6ee0;stroke-width:3px}
        .graph-link{stroke:#999;stroke-opacity:0.6}
        .graph-link.highlighted{stroke:#4a6ee0;stroke-opacity:1;stroke-width:2px}
        .graph-label{font-size:12px;pointer-events:none;text-shadow:0 1px 0 #fff,1px 0 0 #fff,0 -1px 0 #fff,-1px 0 0 #fff}
        .graph-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
        .graph-stat-card{background:white;border-radius:8px;padding:15px;box-shadow:0 2px 5px rgba(0,0,0,0.05);text-align:center}
        .graph-stat-number{font-size:1.8rem;font-weight:bold;color:#4a6ee0;margin-bottom:5px}
        .graph-stat-label{color:#666;font-size:0.85rem}
        .graph-filters{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap}
        .filter-group{display:flex;flex-direction:column;gap:5px}
        .filter-label{font-size:0.9rem;font-weight:500;color:#555}
        .filter-select{padding:8px 12px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer}
        .graph-info-panel{background:white;border-radius:8px;padding:20px;margin-top:20px;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
        .info-panel-header{font-weight:600;margin-bottom:15px;color:#4a6ee0;display:flex;justify-content:space-between;align-items:center}
        .info-panel-content{max-height:200px;overflow-y:auto}
        .info-item{padding:8px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between}
        .info-item:last-child{border-bottom:none}
        
        /* å®˜æ–¹ç™»å½•ç›¸å…³æ ·å¼ */
        .header-btn {
            padding: 8px 16px;
            background: #4a6ee0;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .header-btn:hover {
            background: #3a5ed0;
        }
        
        /* å‘é€é€šçŸ¥æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .batch-action-btn.notify {
            background: #2ecc71 !important;
        }
        
        .batch-action-btn.notify:hover {
            background: #27ae60 !important;
        }
        
        /* é€šçŸ¥ç»Ÿè®¡ä¿¡æ¯ */
        #notificationStats {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        #notificationStats div {
            margin-bottom: 5px;
        }
        
        #notificationStats div:last-child {
            margin-bottom: 0;
        }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f5f7fa;
        }
        
        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #4a6ee0;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
        }
        
        /* å‘é€é€šçŸ¥ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
        .notification-users-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .notification-user-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-user-item:hover {
            background: #f8f9fa;
        }
        
        .notification-user-item.selected {
            background: #e3f2fd;
        }
        
        .notification-user-checkbox {
            margin-right: 10px;
        }
        
        .notification-users-search {
            margin-bottom: 10px;
        }
        
        .notification-users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .notification-users-count {
            font-size: 0.9rem;
            color: #666;
        }
        
        .notification-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .notification-search-input {
            flex: 1;
            min-width: 150px;
        }
        
        .notification-buttons-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .admin-container{padding:10px}.admin-header{flex-direction:column;gap:15px;align-items:flex-start}.stats-container{grid-template-columns:1fr}th,td{padding:8px 10px;font-size:0.9rem}.tabs{flex-wrap:wrap}.tab{flex:1;min-width:120px;text-align:center}.search-container{flex-direction:column}.search-input{min-width:auto}.batch-actions{flex-direction:column;align-items:flex-start}.network-graph-container{height:500px}.graph-stats{grid-template-columns:1fr 1fr}.graph-filters{flex-direction:column}
            
            .login-box {
                padding: 20px;
                margin: 20px;
            }
            
            .modal {
                max-width: 95%;
                margin: 20px;
            }
            
            .notification-search-container {
                flex-direction: column;
            }
            
            .notification-buttons-container {
                flex-direction: column;
            }
            
            .notification-users-container {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-header">
                <h1>èŠå¤©å®¤åå°ç®¡ç†ç³»ç»Ÿ</h1>
                <p>è¯·ä½¿ç”¨å®˜æ–¹è´¦å·ç™»å½•</p>
            </div>
            <div class="form-group">
                <label class="form-label">å®˜æ–¹è´¦å·åç§°</label>
                <input type="text" class="form-input" id="officialUsername" placeholder="è¾“å…¥å®˜æ–¹è´¦å·åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç </label>
                <input type="password" class="form-input" id="officialPassword" placeholder="è¾“å…¥å¯†ç ">
            </div>
            <button class="modal-btn confirm" id="loginBtn" style="width: 100%;">ç™»å½•</button>
            <div class="connection-status" style="justify-content: center; margin-top: 20px;">
                <div class="status-dot offline" id="loginStatusDot"></div>
                <span id="loginStatusText">æœªè¿æ¥æ•°æ®åº“</span>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†ç•Œé¢ -->
    <div class="admin-container" id="adminPage" style="display: none;">
        <div class="admin-header">
            <h1>ğŸ“Š èŠå¤©å®¤åå°ç®¡ç†ç³»ç»Ÿ</h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="connection-status">
                    <div class="status-dot offline" id="statusDot"></div>
                    <span id="statusText">æœªè¿æ¥</span>
                </div>
                <div id="officialUserInfo">
                    <span style="color: #4a6ee0; font-weight: 500;">å®˜æ–¹è´¦å·å·²ç™»å½•</span>
                    <button class="header-btn" id="sendNotificationBtn" style="margin-left: 10px;">å‘é€é€šçŸ¥</button>
                    <button class="header-btn" id="logoutOfficialBtn" style="margin-left: 5px;">é€€å‡º</button>
                </div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalFriendships">0</div>
                <div class="stat-label">å¥½å‹å…³ç³»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalMessages">0</div>
                <div class="stat-label">æ¶ˆæ¯æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayMessages">0</div>
                <div class="stat-label">ä»Šæ—¥æ¶ˆæ¯æ•°</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="users">ç”¨æˆ·ç®¡ç†</div>
            <div class="tab" data-tab="friendships">å¥½å‹å…³ç³»</div>
            <div class="tab" data-tab="messages">æ¶ˆæ¯ç®¡ç†</div>
            <div class="tab" data-tab="network">å…³ç³»ç½‘ç»œå›¾</div>
        </div>
        
        <div class="tab-content active" id="users-tab">
            <div class="search-container">
                <input type="text" class="search-input" id="userSearch" placeholder="æœç´¢ç”¨æˆ·åæˆ–å¥½å‹ç ...">
                <button class="search-btn" id="userSearchBtn">æœç´¢</button>
                <button class="refresh-btn" id="refreshUsers">â†» åˆ·æ–°</button>
            </div>
            
            <div class="batch-actions" id="usersBatchActions">
                <button class="batch-action-btn" id="usersSelectAll">å…¨é€‰</button>
                <button class="batch-action-btn" id="usersSelectNone">å–æ¶ˆå…¨é€‰</button>
                <button class="batch-action-btn delete" id="usersBatchDelete" disabled>æ‰¹é‡åˆ é™¤</button>
                <button class="batch-action-btn notify" id="usersSendNotification" disabled>å‘é€é€šçŸ¥</button>
                <span class="selected-count" id="usersSelectedCount">å·²é€‰æ‹© 0 é¡¹</span>
            </div>
            
            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="usersSelectAllCheckbox">
                            </th>
                            <th class="sortable" data-sort="username">ç”¨æˆ·å</th>
                            <th class="sortable" data-sort="friend_code">å¥½å‹ç </th>
                            <th class="sortable" data-sort="created_at">æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="usersPagination">
            </div>
        </div>
        
        <div class="tab-content" id="friendships-tab">
            <div class="search-container">
                <input type="text" class="search-input" id="friendshipSearch" placeholder="æœç´¢ç”¨æˆ·å...">
                <button class="search-btn" id="friendshipSearchBtn">æœç´¢</button>
                <button class="refresh-btn" id="refreshFriendships">â†» åˆ·æ–°</button>
            </div>
            
            <div class="batch-actions" id="friendshipsBatchActions">
                <button class="batch-action-btn" id="friendshipsSelectAll">å…¨é€‰</button>
                <button class="batch-action-btn" id="friendshipsSelectNone">å–æ¶ˆå…¨é€‰</button>
                <button class="batch-action-btn delete" id="friendshipsBatchDelete" disabled>æ‰¹é‡åˆ é™¤</button>
                <span class="selected-count" id="friendshipsSelectedCount">å·²é€‰æ‹© 0 é¡¹</span>
            </div>
            
            <div class="table-container">
                <table id="friendshipsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="friendshipsSelectAllCheckbox">
                            </th>
                            <th class="sortable" data-sort="user_id">ç”¨æˆ·</th>
                            <th class="sortable" data-sort="friend_id">å¥½å‹</th>
                            <th class="sortable" data-sort="status">çŠ¶æ€</th>
                            <th class="sortable" data-sort="created_at">åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="friendshipsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="friendshipsPagination">
            </div>
        </div>
        
        <div class="tab-content" id="messages-tab">
            <div class="search-container">
                <input type="text" class="search-input" id="messageSearch" placeholder="æœç´¢ç”¨æˆ·åæˆ–æ¶ˆæ¯å†…å®¹...">
                <button class="search-btn" id="messageSearchBtn">æœç´¢</button>
                <button class="refresh-btn" id="refreshMessages">â†» åˆ·æ–°</button>
            </div>
            
            <div class="batch-actions" id="messagesBatchActions">
                <button class="batch-action-btn" id="messagesSelectAll">å…¨é€‰</button>
                <button class="batch-action-btn" id="messagesSelectNone">å–æ¶ˆå…¨é€‰</button>
                <button class="batch-action-btn delete" id="messagesBatchDelete" disabled>æ‰¹é‡åˆ é™¤</button>
                <span class="selected-count" id="messagesSelectedCount">å·²é€‰æ‹© 0 é¡¹</span>
            </div>
            
            <div class="table-container">
                <table id="messagesTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="messagesSelectAllCheckbox">
                            </th>
                            <th class="sortable" data-sort="sender_id">å‘é€è€…</th>
                            <th>æ–¹å‘</th>
                            <th class="sortable" data-sort="receiver_id">æ¥æ”¶è€…</th>
                            <th class="sortable" data-sort="content">å†…å®¹</th>
                            <th class="sortable" data-sort="is_recalled">æ˜¯å¦æ’¤å›</th>
                            <th class="sortable" data-sort="created_at">å‘é€æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="messagesTableBody">
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="messagesPagination">
            </div>
        </div>
        
        <div class="tab-content" id="network-tab">
            <div class="search-container">
                <input type="text" class="search-input" id="graphSearch" placeholder="æœç´¢ç”¨æˆ·...">
                <button class="search-btn" id="graphSearchBtn">æœç´¢</button>
                <button class="refresh-btn" id="refreshGraph">â†» åˆ·æ–°å›¾è¡¨</button>
            </div>
            
            <div class="graph-stats">
                <div class="graph-stat-card">
                    <div class="graph-stat-number" id="graphNodeCount">0</div>
                    <div class="graph-stat-label">ç”¨æˆ·èŠ‚ç‚¹</div>
                </div>
                <div class="graph-stat-card">
                    <div class="graph-stat-number" id="graphLinkCount">0</div>
                    <div class="graph-stat-label">å¥½å‹å…³ç³»</div>
                </div>
                <div class="graph-stat-card">
                    <div class="graph-stat-number" id="graphIsolatedCount">0</div>
                    <div class="graph-stat-label">å­¤ç«‹ç”¨æˆ·</div>
                </div>
                <div class="graph-stat-card">
                    <div class="graph-stat-number" id="graphConnectedCount">0</div>
                    <div class="graph-stat-label">æœ€å¤§è¿æ¥ç»„</div>
                </div>
            </div>
            
            <div class="graph-filters">
                <div class="filter-group">
                    <label class="filter-label">èŠ‚ç‚¹å¤§å°</label>
                    <select class="filter-select" id="nodeSizeFilter">
                        <option value="degree">æŒ‰å¥½å‹æ•°</option>
                        <option value="fixed">å›ºå®šå¤§å°</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">å¸ƒå±€ç®—æ³•</label>
                    <select class="filter-select" id="layoutFilter">
                        <option value="force">åŠ›å¯¼å‘å¸ƒå±€</option>
                        <option value="radial">å¾„å‘å¸ƒå±€</option>
                        <option value="circular">åœ†å½¢å¸ƒå±€</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">æ˜¾ç¤ºæ ‡ç­¾</label>
                    <select class="filter-select" id="labelFilter">
                        <option value="all">å…¨éƒ¨æ˜¾ç¤º</option>
                        <option value="selected">ä»…é€‰ä¸­</option>
                        <option value="none">ä¸æ˜¾ç¤º</option>
                    </select>
                </div>
            </div>
            
            <div class="network-graph-container" id="networkGraph">
                <!-- å›¾ä¾‹å·²ç§»é™¤ -->
            </div>
            
            <div class="graph-info-panel">
                <div class="info-panel-header">
                    <span>ç½‘ç»œå›¾ä¿¡æ¯</span>
                    <button class="action-btn" id="toggleInfoPanel">æŠ˜å </button>
                </div>
                <div class="info-panel-content" id="infoPanelContent">
                    <div class="info-item">
                        <span>æ€»ç”¨æˆ·æ•°</span>
                        <span id="infoTotalUsers">0</span>
                    </div>
                    <div class="info-item">
                        <span>æ€»å¥½å‹å…³ç³»æ•°</span>
                        <span id="infoTotalRelationships">0</span>
                    </div>
                    <div class="info-item">
                        <span>ç½‘ç»œå¯†åº¦</span>
                        <span id="infoNetworkDensity">0</span>
                    </div>
                    <div class="info-item">
                        <span>å¹³å‡å¥½å‹æ•°</span>
                        <span id="infoAverageDegree">0</span>
                    </div>
                    <div class="info-item">
                        <span>æœ€å¤§å¥½å‹æ•°</span>
                        <span id="infoMaxDegree">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal">
            <div class="modal-header">ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·ID</label>
                    <input type="text" class="form-input" id="editUserId" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-input" id="editUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-input" id="editPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰">
                </div>
                <div class="form-group">
                    <label class="form-label">å¥½å‹ç </label>
                    <input type="text" class="form-input" id="editFriendCode" placeholder="è¾“å…¥å¥½å‹ç ">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤´åƒURL</label>
                    <input type="text" class="form-input" id="editAvatarUrl" placeholder="è¾“å…¥å¤´åƒURL">
                </div>
                <div class="avatar-preview">
                    <div class="avatar-preview-img" id="editAvatarPreview"></div>
                    <div class="avatar-preview-text">å¤´åƒé¢„è§ˆ</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelEditUser">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="confirmEditUser">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal">
            <div class="modal-header">ç¡®è®¤åˆ é™¤</div>
            <div class="modal-body" id="deleteConfirmMessage">
                ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelDelete">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="confirmDelete">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="batchDeleteConfirmModal">
        <div class="modal">
            <div class="modal-header">ç¡®è®¤æ‰¹é‡åˆ é™¤</div>
            <div class="modal-body" id="batchDeleteConfirmMessage">
                ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelBatchDelete">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="confirmBatchDelete">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- å‘é€é€šçŸ¥æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="sendNotificationModal">
        <div class="modal">
            <div class="modal-header">å‘é€é€šçŸ¥æ¶ˆæ¯</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">é€šçŸ¥å†…å®¹</label>
                    <textarea class="form-input" id="notificationContent" placeholder="è¾“å…¥é€šçŸ¥æ¶ˆæ¯å†…å®¹" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">å‘é€ç»™</label>
                    <div>
                        <label><input type="radio" name="sendTo" value="selected" checked> é€‰ä¸­çš„ç”¨æˆ·</label>
                        <label style="margin-left: 15px;"><input type="radio" name="sendTo" value="all"> æ‰€æœ‰ç”¨æˆ·</label>
                        <label style="margin-left: 15px;"><input type="radio" name="sendTo" value="custom"> è‡ªå®šä¹‰é€‰æ‹©</label>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰ç”¨æˆ·é€‰æ‹©åŒºåŸŸ -->
                <div id="customUserSelection" style="display: none; margin-top: 15px;">
                    <div class="notification-users-header">
                        <h4>é€‰æ‹©ç”¨æˆ·</h4>
                        <span class="notification-users-count" id="customSelectedCount">å·²é€‰æ‹© 0 ä¸ªç”¨æˆ·</span>
                    </div>
                    
                    <div class="notification-search-container">
                        <input type="text" class="search-input notification-search-input" id="notificationUserSearch" placeholder="æœç´¢ç”¨æˆ·å...">
                        <button class="search-btn" id="notificationUserSearchBtn">æœç´¢</button>
                    </div>
                    
                    <div class="notification-buttons-container">
                        <button class="batch-action-btn" id="notificationSelectAll">å…¨é€‰</button>
                        <button class="batch-action-btn" id="notificationSelectNone">å–æ¶ˆå…¨é€‰</button>
                    </div>
                    
                    <div class="notification-users-container" id="notificationUsersList">
                        <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å‘é€ç»Ÿè®¡</label>
                    <div id="notificationStats">
                        <div>å°†å‘é€ç»™: <span id="recipientCount">0</span> ä¸ªç”¨æˆ·</div>
                        <div>å½“å‰é€‰ä¸­: <span id="selectedUsersCount">0</span> ä¸ªç”¨æˆ·</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelSendNotification">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="confirmSendNotification">å‘é€é€šçŸ¥</button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®Supabase
        const SUPABASE_URL = 'https://rudtcwlggkaxykrhhdsn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZHRjd2xnZ2theHlrcmhoZHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzkyNjEsImV4cCI6MjA3NDkxNTI2MX0.Tb1zZvaRS2rppM1_7ka4WgpIh_PFxc4bLVHPG9T0AKg';
        
        // å®˜æ–¹è´¦å·æ ‡è¯†
        const OFFICIAL_USERNAME = 'admin';
        
        let supabase = null;
        let isConnected = false;
        let userCache = new Map();
        let currentEditingUser = null;
        let currentDeleteItem = {type: null, id: null};
        
        // å®˜æ–¹ç™»å½•ç›¸å…³å˜é‡
        let isOfficialLoggedIn = false;
        let officialSession = null;
        
        let currentUsersPage = 1;
        let currentFriendshipsPage = 1;
        let currentMessagesPage = 1;
        const itemsPerPage = 10;
        
        let usersSortState = {field: 'created_at', order: 'desc'};
        let friendshipsSortState = {field: 'created_at', order: 'desc'};
        let messagesSortState = {field: 'created_at', order: 'desc'};
        
        let selectedUsers = new Set();
        let selectedFriendships = new Set();
        let selectedMessages = new Set();
        
        let graphData = {nodes: [], links: []};
        let simulation = null;
        let svg = null;
        let zoom = null;
        let tooltip = null;
        let isInfoPanelCollapsed = false;
        
        // å‘é€é€šçŸ¥ç›¸å…³å˜é‡
        let notificationSelectedUsers = new Set();
        
        const elements = {};
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        function init() {
            cacheDOMElements();
            initializeSupabase();
            setupEventListeners();
        }
        
        // ç¼“å­˜DOMå…ƒç´ 
        function cacheDOMElements() {
            // ç™»å½•é¡µé¢å…ƒç´ 
            elements.loginPage = document.getElementById('loginPage');
            elements.adminPage = document.getElementById('adminPage');
            elements.officialUsername = document.getElementById('officialUsername');
            elements.officialPassword = document.getElementById('officialPassword');
            elements.loginBtn = document.getElementById('loginBtn');
            elements.loginStatusDot = document.getElementById('loginStatusDot');
            elements.loginStatusText = document.getElementById('loginStatusText');
            
            // ç®¡ç†ç•Œé¢å…ƒç´ 
            elements.statusDot = document.getElementById('statusDot');
            elements.statusText = document.getElementById('statusText');
            elements.tabs = document.querySelectorAll('.tab');
            elements.tabContents = document.querySelectorAll('.tab-content');
            
            elements.totalUsers = document.getElementById('totalUsers');
            elements.totalFriendships = document.getElementById('totalFriendships');
            elements.totalMessages = document.getElementById('totalMessages');
            elements.todayMessages = document.getElementById('todayMessages');
            
            elements.usersTableBody = document.getElementById('usersTableBody');
            elements.usersPagination = document.getElementById('usersPagination');
            elements.userSearch = document.getElementById('userSearch');
            elements.userSearchBtn = document.getElementById('userSearchBtn');
            elements.refreshUsers = document.getElementById('refreshUsers');
            elements.usersSelectAll = document.getElementById('usersSelectAll');
            elements.usersSelectNone = document.getElementById('usersSelectNone');
            elements.usersBatchDelete = document.getElementById('usersBatchDelete');
            elements.usersSendNotification = document.getElementById('usersSendNotification');
            elements.usersSelectedCount = document.getElementById('usersSelectedCount');
            elements.usersSelectAllCheckbox = document.getElementById('usersSelectAllCheckbox');
            
            elements.friendshipsTableBody = document.getElementById('friendshipsTableBody');
            elements.friendshipsPagination = document.getElementById('friendshipsPagination');
            elements.friendshipSearch = document.getElementById('friendshipSearch');
            elements.friendshipSearchBtn = document.getElementById('friendshipSearchBtn');
            elements.refreshFriendships = document.getElementById('refreshFriendships');
            elements.friendshipsSelectAll = document.getElementById('friendshipsSelectAll');
            elements.friendshipsSelectNone = document.getElementById('friendshipsSelectNone');
            elements.friendshipsBatchDelete = document.getElementById('friendshipsBatchDelete');
            elements.friendshipsSelectedCount = document.getElementById('friendshipsSelectedCount');
            elements.friendshipsSelectAllCheckbox = document.getElementById('friendshipsSelectAllCheckbox');
            
            elements.messagesTableBody = document.getElementById('messagesTableBody');
            elements.messagesPagination = document.getElementById('messagesPagination');
            elements.messageSearch = document.getElementById('messageSearch');
            elements.messageSearchBtn = document.getElementById('messageSearchBtn');
            elements.refreshMessages = document.getElementById('refreshMessages');
            elements.messagesSelectAll = document.getElementById('messagesSelectAll');
            elements.messagesSelectNone = document.getElementById('messagesSelectNone');
            elements.messagesBatchDelete = document.getElementById('messagesBatchDelete');
            elements.messagesSelectedCount = document.getElementById('messagesSelectedCount');
            elements.messagesSelectAllCheckbox = document.getElementById('messagesSelectAllCheckbox');
            
            elements.networkGraph = document.getElementById('networkGraph');
            elements.graphSearch = document.getElementById('graphSearch');
            elements.graphSearchBtn = document.getElementById('graphSearchBtn');
            elements.refreshGraph = document.getElementById('refreshGraph');
            elements.nodeSizeFilter = document.getElementById('nodeSizeFilter');
            elements.layoutFilter = document.getElementById('layoutFilter');
            elements.labelFilter = document.getElementById('labelFilter');
            elements.toggleInfoPanel = document.getElementById('toggleInfoPanel');
            elements.infoPanelContent = document.getElementById('infoPanelContent');
            
            elements.graphNodeCount = document.getElementById('graphNodeCount');
            elements.graphLinkCount = document.getElementById('graphLinkCount');
            elements.graphIsolatedCount = document.getElementById('graphIsolatedCount');
            elements.graphConnectedCount = document.getElementById('graphConnectedCount');
            
            elements.infoTotalUsers = document.getElementById('infoTotalUsers');
            elements.infoTotalRelationships = document.getElementById('infoTotalRelationships');
            elements.infoNetworkDensity = document.getElementById('infoNetworkDensity');
            elements.infoAverageDegree = document.getElementById('infoAverageDegree');
            elements.infoMaxDegree = document.getElementById('infoMaxDegree');
            
            elements.editUserModal = document.getElementById('editUserModal');
            elements.editUserId = document.getElementById('editUserId');
            elements.editUsername = document.getElementById('editUsername');
            elements.editPassword = document.getElementById('editPassword');
            elements.editFriendCode = document.getElementById('editFriendCode');
            elements.editAvatarUrl = document.getElementById('editAvatarUrl');
            elements.editAvatarPreview = document.getElementById('editAvatarPreview');
            elements.cancelEditUser = document.getElementById('cancelEditUser');
            elements.confirmEditUser = document.getElementById('confirmEditUser');
            
            elements.deleteConfirmModal = document.getElementById('deleteConfirmModal');
            elements.deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
            elements.cancelDelete = document.getElementById('cancelDelete');
            elements.confirmDelete = document.getElementById('confirmDelete');
            
            elements.batchDeleteConfirmModal = document.getElementById('batchDeleteConfirmModal');
            elements.batchDeleteConfirmMessage = document.getElementById('batchDeleteConfirmMessage');
            elements.cancelBatchDelete = document.getElementById('cancelBatchDelete');
            elements.confirmBatchDelete = document.getElementById('confirmBatchDelete');
            
            // å®˜æ–¹ç™»å½•ç›¸å…³å…ƒç´ 
            elements.officialUserInfo = document.getElementById('officialUserInfo');
            elements.sendNotificationBtn = document.getElementById('sendNotificationBtn');
            elements.logoutOfficialBtn = document.getElementById('logoutOfficialBtn');
            
            // å‘é€é€šçŸ¥ç›¸å…³å…ƒç´ 
            elements.sendNotificationModal = document.getElementById('sendNotificationModal');
            elements.notificationContent = document.getElementById('notificationContent');
            elements.cancelSendNotification = document.getElementById('cancelSendNotification');
            elements.confirmSendNotification = document.getElementById('confirmSendNotification');
            elements.recipientCount = document.getElementById('recipientCount');
            elements.selectedUsersCount = document.getElementById('selectedUsersCount');
            elements.customUserSelection = document.getElementById('customUserSelection');
            elements.customSelectedCount = document.getElementById('customSelectedCount');
            elements.notificationUserSearch = document.getElementById('notificationUserSearch');
            elements.notificationUserSearchBtn = document.getElementById('notificationUserSearchBtn');
            elements.notificationSelectAll = document.getElementById('notificationSelectAll');
            elements.notificationSelectNone = document.getElementById('notificationSelectNone');
            elements.notificationUsersList = document.getElementById('notificationUsersList');
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç™»å½•é¡µé¢äº‹ä»¶
            elements.loginBtn.addEventListener('click', handleOfficialLogin);
            elements.officialPassword.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    handleOfficialLogin();
                }
            });
            
            // ç®¡ç†é¡µé¢äº‹ä»¶
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            elements.userSearchBtn.addEventListener('click', () => {
                currentUsersPage = 1;
                loadUsersData();
            });
            
            elements.friendshipSearchBtn.addEventListener('click', () => {
                currentFriendshipsPage = 1;
                loadFriendshipsData();
            });
            
            elements.messageSearchBtn.addEventListener('click', () => {
                currentMessagesPage = 1;
                loadMessagesData();
            });
            
            elements.graphSearchBtn.addEventListener('click', () => {
                filterGraphBySearch();
            });
            
            elements.refreshUsers.addEventListener('click', loadUsersData);
            elements.refreshFriendships.addEventListener('click', loadFriendshipsData);
            elements.refreshMessages.addEventListener('click', loadMessagesData);
            elements.refreshGraph.addEventListener('click', initializeNetworkGraph);
            
            elements.userSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    currentUsersPage = 1;
                    loadUsersData();
                }
            });
            
            elements.friendshipSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    currentFriendshipsPage = 1;
                    loadFriendshipsData();
                }
            });
            
            elements.messageSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    currentMessagesPage = 1;
                    loadMessagesData();
                }
            });
            
            elements.graphSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    filterGraphBySearch();
                }
            });
            
            elements.cancelEditUser.addEventListener('click', () => {
                elements.editUserModal.classList.remove('show');
                currentEditingUser = null;
            });
            
            elements.confirmEditUser.addEventListener('click', saveUserInfo);
            
            elements.editAvatarUrl.addEventListener('input', function() {
                updateAvatarPreview('editAvatarPreview', this.value, elements.editUsername.value);
            });
            
            elements.cancelDelete.addEventListener('click', () => {
                elements.deleteConfirmModal.classList.remove('show');
                currentDeleteItem = {type: null, id: null};
            });
            
            elements.confirmDelete.addEventListener('click', deleteItem);
            
            elements.cancelBatchDelete.addEventListener('click', () => {
                elements.batchDeleteConfirmModal.classList.remove('show');
            });
            
            elements.confirmBatchDelete.addEventListener('click', batchDeleteItems);
            
            // å®˜æ–¹ç™»å½•ç›¸å…³äº‹ä»¶
            elements.logoutOfficialBtn.addEventListener('click', handleOfficialLogout);
            elements.sendNotificationBtn.addEventListener('click', openSendNotificationModal);
            
            // å‘é€é€šçŸ¥ç›¸å…³äº‹ä»¶
            elements.cancelSendNotification.addEventListener('click', closeSendNotificationModal);
            elements.confirmSendNotification.addEventListener('click', sendNotifications);
            
            // ç”¨æˆ·ç®¡ç†ä¸­çš„å‘é€é€šçŸ¥æŒ‰é’®
            elements.usersSendNotification.addEventListener('click', openSendNotificationModal);
            
            // ç›‘å¬å‘é€å¯¹è±¡é€‰æ‹©å˜åŒ–
            document.querySelectorAll('input[name="sendTo"]').forEach(radio => {
                radio.addEventListener('change', updateNotificationStats);
            });
            
            // å‘é€é€šçŸ¥ç”¨æˆ·åˆ—è¡¨ç›¸å…³äº‹ä»¶
            elements.notificationUserSearchBtn.addEventListener('click', loadNotificationUsers);
            elements.notificationUserSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    loadNotificationUsers();
                }
            });
            elements.notificationSelectAll.addEventListener('click', () => selectAllNotificationUsers());
            elements.notificationSelectNone.addEventListener('click', () => selectNoneNotificationUsers());
            
            setupTableSorting();
            setupBatchActions();
            setupGraphFilters();
            elements.toggleInfoPanel.addEventListener('click', toggleInfoPanelVisibility);
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabId) {
            elements.tabs.forEach(t => t.classList.remove('active'));
            elements.tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            switch(tabId) {
                case 'users':
                    loadUsersData();
                    break;
                case 'friendships':
                    loadFriendshipsData();
                    break;
                case 'messages':
                    loadMessagesData();
                    break;
                case 'network':
                    initializeNetworkGraph();
                    break;
            }
        }
        
        // åˆå§‹åŒ–Supabase
        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                testConnection();
            } catch (error) {
                console.error('åˆå§‹åŒ–Supabaseé”™è¯¯:', error);
                updateConnectionStatus(false);
            }
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                    updateConnectionStatus(false);
                } else {
                    updateConnectionStatus(true);
                }
            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                updateConnectionStatus(false);
            }
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                elements.statusDot.classList.remove('offline');
                elements.statusText.textContent = 'å·²è¿æ¥åˆ°Supabase';
                elements.loginStatusDot.classList.remove('offline');
                elements.loginStatusText.textContent = 'å·²è¿æ¥åˆ°æ•°æ®åº“';
            } else {
                elements.statusDot.classList.add('offline');
                elements.statusText.textContent = 'è¿æ¥å¤±è´¥';
                elements.loginStatusDot.classList.add('offline');
                elements.loginStatusText.textContent = 'è¿æ¥æ•°æ®åº“å¤±è´¥';
            }
        }
        
        // å®˜æ–¹ç™»å½•å¤„ç†
        async function handleOfficialLogin() {
            const username = elements.officialUsername.value.trim();
            const password = elements.officialPassword.value.trim();
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥å®˜æ–¹è´¦å·åç§°å’Œå¯†ç ');
                return;
            }
            
            try {
                // éªŒè¯å®˜æ–¹è´¦å·
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, username, password')
                    .eq('username', username);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert('å®˜æ–¹è´¦å·ä¸å­˜åœ¨');
                    return;
                }
                
                const officialAccount = data[0];
                
                // éªŒè¯å¯†ç ï¼ˆè¿™é‡Œå‡è®¾å¯†ç æ˜¯æ˜æ–‡å­˜å‚¨ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨åŠ å¯†éªŒè¯ï¼‰
                if (officialAccount.password !== password) {
                    alert('å¯†ç é”™è¯¯');
                    return;
                }
                
                // ç™»å½•æˆåŠŸ
                isOfficialLoggedIn = true;
                officialSession = {
                    id: officialAccount.id,
                    username: officialAccount.username
                };
                
                // åˆ‡æ¢åˆ°ç®¡ç†ç•Œé¢
                elements.loginPage.style.display = 'none';
                elements.adminPage.style.display = 'block';
                
                // åŠ è½½ç®¡ç†æ•°æ®
                loadStats();
                loadUsersData();
                loadAllUsers();
                
                alert('å®˜æ–¹è´¦å·ç™»å½•æˆåŠŸï¼');
                
            } catch (error) {
                console.error('å®˜æ–¹ç™»å½•é”™è¯¯:', error);
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        }
        
        // å®˜æ–¹ç™»å‡ºå¤„ç†
        function handleOfficialLogout() {
            isOfficialLoggedIn = false;
            officialSession = null;
            
            // åˆ‡æ¢å›ç™»å½•ç•Œé¢
            elements.loginPage.style.display = 'flex';
            elements.adminPage.style.display = 'none';
            
            // æ¸…ç©ºç™»å½•è¡¨å•
            elements.officialUsername.value = '';
            elements.officialPassword.value = '';
            
            alert('å®˜æ–¹è´¦å·å·²é€€å‡º');
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            if (!supabase) return;
            
            try {
                const { count: usersCount, error: usersError } = await supabase
                    .from('profiles')
                    .select('*', { count: 'exact', head: true });
                
                if (!usersError) {
                    elements.totalUsers.textContent = usersCount || 0;
                }
                
                const { count: friendshipsCount, error: friendshipsError } = await supabase
                    .from('friends')
                    .select('*', { count: 'exact', head: true });
                
                if (!friendshipsError) {
                    elements.totalFriendships.textContent = friendshipsCount || 0;
                }
                
                const { count: messagesCount, error: messagesError } = await supabase
                    .from('private_messages')
                    .select('*', { count: 'exact', head: true });
                
                if (!messagesError) {
                    elements.totalMessages.textContent = messagesCount || 0;
                }
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayISO = today.toISOString();
                
                const { count: todayMessagesCount, error: todayMessagesError } = await supabase
                    .from('private_messages')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', todayISO);
                
                if (!todayMessagesError) {
                    elements.todayMessages.textContent = todayMessagesCount || 0;
                }
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®é”™è¯¯:', error);
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·åˆ°ç¼“å­˜
        async function loadAllUsers() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, username, friend_code, avatar_url, created_at');
                
                if (error) throw error;
                
                userCache.clear();
                
                data.forEach(user => {
                    userCache.set(user.id, {
                        username: user.username,
                        friend_code: user.friend_code,
                        avatar_url: user.avatar_url,
                        created_at: user.created_at
                    });
                });
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ç¼“å­˜é”™è¯¯:', error);
            }
        }
        
        // è·å–ç”¨æˆ·å
        function getUserName(userId) {
            const user = userCache.get(userId);
            return user ? user.username : `ç”¨æˆ·(${userId.substring(0, 8)}...)`;
        }
        
        // è·å–ç”¨æˆ·å¤´åƒHTML
        function getUserAvatar(userId) {
            const user = userCache.get(userId);
            const username = user ? user.username : `ç”¨æˆ·(${userId.substring(0, 8)}...)`;
            const avatarUrl = user ? user.avatar_url : null;
            
            if (avatarUrl && isValidUrl(avatarUrl)) {
                return `
                    <div class="user-info">
                        <img src="${avatarUrl}" class="user-avatar-img" alt="${username}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="user-avatar" style="display: none">${username.charAt(0).toUpperCase()}</div>
                        ${username}
                    </div>
                `;
            } else {
                const initial = username.charAt(0).toUpperCase();
                return `
                    <div class="user-info">
                        <div class="user-avatar">${initial}</div>
                        ${username}
                    </div>
                `;
            }
        }
        
        // æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆ
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUsersData() {
            if (!supabase) return;
            
            try {
                elements.usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <div>æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...</div>
                            </div>
                        </td>
                    </tr>
                `;
                
                let query = supabase
                    .from('profiles')
                    .select('*', { count: 'exact' });
                
                const searchTerm = elements.userSearch.value.trim();
                if (searchTerm) {
                    query = query.or(`username.ilike.%${searchTerm}%,friend_code.ilike.%${searchTerm}%`);
                }
                
                query = query.order(usersSortState.field, { 
                    ascending: usersSortState.order === 'asc' 
                });
                
                const from = (currentUsersPage - 1) * itemsPerPage;
                const to = from + itemsPerPage - 1;
                query = query.range(from, to);
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                elements.usersTableBody.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(user => {
                        const isChecked = selectedUsers.has(user.id);
                        const username = user.username || `ç”¨æˆ·(${user.id.substring(0, 8)}...)`;
                        const initial = username.charAt(0).toUpperCase();
                        const avatarUrl = user.avatar_url;
                        
                        let avatarHtml = '';
                        if (avatarUrl && isValidUrl(avatarUrl)) {
                            avatarHtml = `
                                <img src="${avatarUrl}" class="user-avatar-img" alt="${username}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                <div class="user-avatar" style="display: none">${initial}</div>
                            `;
                        } else {
                            avatarHtml = `<div class="user-avatar">${initial}</div>`;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="checkbox-cell">
                                <input type="checkbox" class="user-checkbox" data-id="${user.id}" ${isChecked ? 'checked' : ''}>
                            </td>
                            <td>
                                <div class="user-info">
                                    ${avatarHtml}
                                    ${username}
                                </div>
                            </td>
                            <td>${user.friend_code || 'N/A'}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>
                                <button class="action-btn edit" onclick="openEditUserModal('${user.id}', '${escapeSingleQuote(user.username || '')}', '${escapeSingleQuote(user.friend_code || '')}', '${escapeSingleQuote(user.avatar_url || '')}')">ç¼–è¾‘</button>
                                <button class="action-btn delete" onclick="confirmDeleteItem('user', '${user.id}', '${escapeSingleQuote(user.username || '')}')">åˆ é™¤</button>
                            </td>
                        `;
                        elements.usersTableBody.appendChild(row);
                    });
                    
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const userId = this.getAttribute('data-id');
                            if (this.checked) {
                                selectedUsers.add(userId);
                            } else {
                                selectedUsers.delete(userId);
                            }
                            updateSelectedCount('users');
                        });
                    });
                } else {
                    elements.usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="no-data">æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æ•°æ®</td>
                        </tr>
                    `;
                }
                
                updatePagination(elements.usersPagination, currentUsersPage, count, 'users');
                updateSelectAllCheckbox('users');
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®é”™è¯¯:', error);
                elements.usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥</td>
                    </tr>
                `;
            }
        }
        
        // è½¬ä¹‰å•å¼•å·
        function escapeSingleQuote(str) {
            return str.replace(/'/g, "\\'");
        }
        
        // æ‰“å¼€ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        function openEditUserModal(userId, username, friendCode, avatarUrl) {
            currentEditingUser = userId;
            
            elements.editUserId.value = userId;
            elements.editUsername.value = username || '';
            elements.editFriendCode.value = friendCode || '';
            elements.editAvatarUrl.value = avatarUrl || '';
            elements.editPassword.value = '';
            
            updateAvatarPreview('editAvatarPreview', avatarUrl, username);
            
            elements.editUserModal.classList.add('show');
        }
        
        // æ›´æ–°å¤´åƒé¢„è§ˆ
        function updateAvatarPreview(previewId, avatarUrl, username) {
            const preview = document.getElementById(previewId);
            const initial = username ? username.charAt(0).toUpperCase() : 'U';
            
            if (avatarUrl && isValidUrl(avatarUrl)) {
                preview.style.backgroundImage = `url(${avatarUrl})`;
                preview.textContent = '';
                
                const img = new Image();
                img.onerror = function() {
                    preview.style.backgroundImage = '';
                    preview.textContent = initial;
                    preview.style.backgroundColor = '#4a6ee0';
                };
                img.src = avatarUrl;
            } else {
                preview.style.backgroundImage = '';
                preview.textContent = initial;
                preview.style.backgroundColor = '#4a6ee0';
            }
        }
        
        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        async function saveUserInfo() {
            if (!supabase || !currentEditingUser) return;
            
            const username = elements.editUsername.value.trim();
            const password = elements.editPassword.value.trim();
            const friendCode = elements.editFriendCode.value.trim();
            const avatarUrl = elements.editAvatarUrl.value.trim();
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            try {
                const updateData = {
                    username: username,
                    friend_code: friendCode || null,
                    avatar_url: avatarUrl || null
                };
                
                if (password) {
                    updateData.password = password;
                }
                
                const { error } = await supabase
                    .from('profiles')
                    .update(updateData)
                    .eq('id', currentEditingUser);
                
                if (error) throw error;
                
                alert('ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹æˆåŠŸ');
                elements.editUserModal.classList.remove('show');
                currentEditingUser = null;
                
                loadUsersData();
                loadAllUsers();
                
            } catch (error) {
                console.error('ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
                alert('ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }
        
        // è®¾ç½®è¡¨æ ¼æ’åº
        function setupTableSorting() {
            document.querySelectorAll('#usersTable th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.getAttribute('data-sort');
                    if (usersSortState.field === field) {
                        usersSortState.order = usersSortState.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        usersSortState.field = field;
                        usersSortState.order = 'asc';
                    }
                    updateSortIndicators('usersTable', usersSortState);
                    loadUsersData();
                });
            });
            
            document.querySelectorAll('#friendshipsTable th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.getAttribute('data-sort');
                    if (friendshipsSortState.field === field) {
                        friendshipsSortState.order = friendshipsSortState.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        friendshipsSortState.field = field;
                        friendshipsSortState.order = 'asc';
                    }
                    updateSortIndicators('friendshipsTable', friendshipsSortState);
                    loadFriendshipsData();
                });
            });
            
            document.querySelectorAll('#messagesTable th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.getAttribute('data-sort');
                    if (messagesSortState.field === field) {
                        messagesSortState.order = messagesSortState.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        messagesSortState.field = field;
                        messagesSortState.order = 'asc';
                    }
                    updateSortIndicators('messagesTable', messagesSortState);
                    loadMessagesData();
                });
            });
        }
        
        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        function updateSortIndicators(tableId, sortState) {
            document.querySelectorAll(`#${tableId} th.sortable`).forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            
            const currentTh = document.querySelector(`#${tableId} th[data-sort="${sortState.field}"]`);
            if (currentTh) {
                currentTh.classList.add(sortState.order);
            }
        }
        
        // è®¾ç½®æ‰¹é‡æ“ä½œ
        function setupBatchActions() {
            elements.usersSelectAll.addEventListener('click', () => selectAllItems('users'));
            elements.usersSelectNone.addEventListener('click', () => selectNoneItems('users'));
            elements.usersBatchDelete.addEventListener('click', () => confirmBatchDeleteItems('users'));
            elements.usersSendNotification.addEventListener('click', () => openSendNotificationModal());
            elements.usersSelectAllCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    selectAllItems('users');
                } else {
                    selectNoneItems('users');
                }
            });
            
            elements.friendshipsSelectAll.addEventListener('click', () => selectAllItems('friendships'));
            elements.friendshipsSelectNone.addEventListener('click', () => selectNoneItems('friendships'));
            elements.friendshipsBatchDelete.addEventListener('click', () => confirmBatchDeleteItems('friendships'));
            elements.friendshipsSelectAllCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    selectAllItems('friendships');
                } else {
                    selectNoneItems('friendships');
                }
            });
            
            elements.messagesSelectAll.addEventListener('click', () => selectAllItems('messages'));
            elements.messagesSelectNone.addEventListener('click', () => selectNoneItems('messages'));
            elements.messagesBatchDelete.addEventListener('click', () => confirmBatchDeleteItems('messages'));
            elements.messagesSelectAllCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    selectAllItems('messages');
                } else {
                    selectNoneItems('messages');
                }
            });
        }
        
        // å…¨é€‰é¡¹ç›®
        function selectAllItems(type) {
            switch(type) {
                case 'users':
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.checked = true;
                        const userId = checkbox.getAttribute('data-id');
                        selectedUsers.add(userId);
                    });
                    updateSelectedCount('users');
                    updateSelectAllCheckbox('users');
                    break;
                case 'friendships':
                    document.querySelectorAll('.friendship-checkbox').forEach(checkbox => {
                        checkbox.checked = true;
                        const friendshipId = checkbox.getAttribute('data-id');
                        selectedFriendships.add(friendshipId);
                    });
                    updateSelectedCount('friendships');
                    updateSelectAllCheckbox('friendships');
                    break;
                case 'messages':
                    document.querySelectorAll('.message-checkbox').forEach(checkbox => {
                        checkbox.checked = true;
                        const messageId = checkbox.getAttribute('data-id');
                        selectedMessages.add(messageId);
                    });
                    updateSelectedCount('messages');
                    updateSelectAllCheckbox('messages');
                    break;
            }
        }
        
        // å–æ¶ˆé€‰æ‹©æ‰€æœ‰é¡¹ç›®
        function selectNoneItems(type) {
            switch(type) {
                case 'users':
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    selectedUsers.clear();
                    updateSelectedCount('users');
                    updateSelectAllCheckbox('users');
                    break;
                case 'friendships':
                    document.querySelectorAll('.friendship-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    selectedFriendships.clear();
                    updateSelectedCount('friendships');
                    updateSelectAllCheckbox('friendships');
                    break;
                case 'messages':
                    document.querySelectorAll('.message-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    selectedMessages.clear();
                    updateSelectedCount('messages');
                    updateSelectAllCheckbox('messages');
                    break;
            }
        }
        
        // æ›´æ–°é€‰ä¸­è®¡æ•°
        function updateSelectedCount(type) {
            let count = 0;
            let button = null;
            let notifyButton = null;
            let countElement = null;
            
            switch(type) {
                case 'users':
                    count = selectedUsers.size;
                    button = elements.usersBatchDelete;
                    notifyButton = elements.usersSendNotification;
                    countElement = elements.usersSelectedCount;
                    break;
                case 'friendships':
                    count = selectedFriendships.size;
                    button = elements.friendshipsBatchDelete;
                    countElement = elements.friendshipsSelectedCount;
                    break;
                case 'messages':
                    count = selectedMessages.size;
                    button = elements.messagesBatchDelete;
                    countElement = elements.messagesSelectedCount;
                    break;
            }
            
            countElement.textContent = `å·²é€‰æ‹© ${count} é¡¹`;
            
            if (count > 0) {
                if (button) button.disabled = false;
                if (notifyButton) {
                    notifyButton.disabled = !isOfficialLoggedIn;
                }
            } else {
                if (button) button.disabled = true;
                if (notifyButton) {
                    notifyButton.disabled = true;
                }
            }
        }
        
        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†
        function updateSelectAllCheckbox(type) {
            let allCheckboxes = [];
            let selectAllCheckbox = null;
            
            switch(type) {
                case 'users':
                    allCheckboxes = document.querySelectorAll('.user-checkbox');
                    selectAllCheckbox = elements.usersSelectAllCheckbox;
                    break;
                case 'friendships':
                    allCheckboxes = document.querySelectorAll('.friendship-checkbox');
                    selectAllCheckbox = elements.friendshipsSelectAllCheckbox;
                    break;
                case 'messages':
                    allCheckboxes = document.querySelectorAll('.message-checkbox');
                    selectAllCheckbox = elements.messagesSelectAllCheckbox;
                    break;
            }
            
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.disabled = true;
                return;
            }
            
            selectAllCheckbox.disabled = false;
            
            const allChecked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
            selectAllCheckbox.checked = allChecked;
        }
        
        // ç¡®è®¤æ‰¹é‡åˆ é™¤é¡¹ç›®
        function confirmBatchDeleteItems(type) {
            let count = 0;
            let itemName = '';
            
            switch(type) {
                case 'users':
                    count = selectedUsers.size;
                    itemName = 'ç”¨æˆ·';
                    break;
                case 'friendships':
                    count = selectedFriendships.size;
                    itemName = 'å¥½å‹å…³ç³»';
                    break;
                case 'messages':
                    count = selectedMessages.size;
                    itemName = 'æ¶ˆæ¯';
                    break;
            }
            
            elements.batchDeleteConfirmMessage.textContent = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} æ¡${itemName}è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;
            elements.batchDeleteConfirmModal.classList.add('show');
            elements.batchDeleteConfirmModal.setAttribute('data-type', type);
        }
        
        // åˆ é™¤é¡¹ç›®
        async function deleteItem() {
            if (!supabase || !currentDeleteItem.type || !currentDeleteItem.id) {
                elements.deleteConfirmModal.classList.remove('show');
                return;
            }
            
            try {
                let error;
                
                switch(currentDeleteItem.type) {
                    case 'user':
                        // å…ˆåˆ é™¤ç›¸å…³çš„å¥½å‹å…³ç³»
                        await supabase
                            .from('friends')
                            .delete()
                            .or(`user_id.eq.${currentDeleteItem.id},friend_id.eq.${currentDeleteItem.id}`);
                        
                        // å†åˆ é™¤ç›¸å…³çš„æ¶ˆæ¯
                        await supabase
                            .from('private_messages')
                            .delete()
                            .or(`sender_id.eq.${currentDeleteItem.id},receiver_id.eq.${currentDeleteItem.id}`);
                        
                        // æœ€ååˆ é™¤ç”¨æˆ·
                        const { error: userError } = await supabase
                            .from('profiles')
                            .delete()
                            .eq('id', currentDeleteItem.id);
                        
                        error = userError;
                        break;
                        
                    case 'friendship':
                        const { error: friendshipError } = await supabase
                            .from('friends')
                            .delete()
                            .eq('id', currentDeleteItem.id);
                        
                        error = friendshipError;
                        break;
                        
                    case 'message':
                        const { error: messageError } = await supabase
                            .from('private_messages')
                            .delete()
                            .eq('id', currentDeleteItem.id);
                        
                        error = messageError;
                        break;
                }
                
                if (error) throw error;
                
                alert('åˆ é™¤æˆåŠŸ');
                elements.deleteConfirmModal.classList.remove('show');
                currentDeleteItem = {type: null, id: null};
                
                loadStats();
                switch(currentDeleteItem.type) {
                    case 'user':
                        loadUsersData();
                        loadAllUsers();
                        break;
                    case 'friendship':
                        loadFriendshipsData();
                        break;
                    case 'message':
                        loadMessagesData();
                        break;
                }
                
            } catch (error) {
                console.error('åˆ é™¤é”™è¯¯:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // æ‰¹é‡åˆ é™¤é¡¹ç›®
        async function batchDeleteItems() {
            const type = elements.batchDeleteConfirmModal.getAttribute('data-type');
            let ids = [];
            
            switch(type) {
                case 'users':
                    ids = Array.from(selectedUsers);
                    break;
                case 'friendships':
                    ids = Array.from(selectedFriendships);
                    break;
                case 'messages':
                    ids = Array.from(selectedMessages);
                    break;
            }
            
            if (ids.length === 0) {
                elements.batchDeleteConfirmModal.classList.remove('show');
                return;
            }
            
            try {
                // æ·»åŠ åˆ é™¤ä¸­çŠ¶æ€
                elements.confirmBatchDelete.disabled = true;
                elements.confirmBatchDelete.textContent = 'åˆ é™¤ä¸­...';
                
                let successCount = 0;
                let errorCount = 0;
                
                // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…URLè¿‡é•¿å’Œæ•°æ®åº“å‹åŠ›
                const batchSize = 10; // æ¯æ‰¹å¤„ç†10æ¡è®°å½•
                const totalBatches = Math.ceil(ids.length / batchSize);
                
                for (let i = 0; i < totalBatches; i++) {
                    const startIdx = i * batchSize;
                    const endIdx = Math.min(startIdx + batchSize, ids.length);
                    const batchIds = ids.slice(startIdx, endIdx);
                    
                    try {
                        let batchError;
                        
                        switch(type) {
                            case 'users':
                                // å…ˆåˆ é™¤ç›¸å…³çš„å¥½å‹å…³ç³»
                                const { error: friendsError } = await supabase
                                    .from('friends')
                                    .delete()
                                    .or(`user_id.in.(${batchIds.join(',')}),friend_id.in.(${batchIds.join(',')})`);
                                
                                if (friendsError) throw friendsError;
                                
                                // å†åˆ é™¤ç›¸å…³çš„æ¶ˆæ¯
                                const { error: messagesError } = await supabase
                                    .from('private_messages')
                                    .delete()
                                    .or(`sender_id.in.(${batchIds.join(',')}),receiver_id.in.(${batchIds.join(',')})`);
                                
                                if (messagesError) throw messagesError;
                                
                                // æœ€ååˆ é™¤ç”¨æˆ·
                                const { error: userError } = await supabase
                                    .from('profiles')
                                    .delete()
                                    .in('id', batchIds);
                                
                                batchError = userError;
                                break;
                                
                            case 'friendships':
                                const { error: friendshipError } = await supabase
                                    .from('friends')
                                    .delete()
                                    .in('id', batchIds);
                                
                                batchError = friendshipError;
                                break;
                                
                            case 'messages':
                                const { error: messageError } = await supabase
                                    .from('private_messages')
                                    .delete()
                                    .in('id', batchIds);
                                
                                batchError = messageError;
                                break;
                        }
                        
                        if (batchError) {
                            console.error(`ç¬¬ ${i + 1} æ‰¹åˆ é™¤å¤±è´¥:`, batchError);
                            errorCount += batchIds.length;
                            // ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                        } else {
                            successCount += batchIds.length;
                        }
                        
                        // æ›´æ–°è¿›åº¦
                        const progress = Math.min((i + 1) * batchSize, ids.length);
                        elements.confirmBatchDelete.textContent = `åˆ é™¤ä¸­... ${progress}/${ids.length}`;
                        
                        // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                        if (i < totalBatches - 1) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (batchError) {
                        console.error(`ç¬¬ ${i + 1} æ‰¹å¤„ç†é”™è¯¯:`, batchError);
                        errorCount += batchIds.length;
                    }
                }
                
                let message = '';
                if (successCount > 0 && errorCount === 0) {
                    message = `æˆåŠŸåˆ é™¤ ${successCount} æ¡è®°å½•`;
                } else if (successCount > 0 && errorCount > 0) {
                    message = `åˆ é™¤å®Œæˆï¼æˆåŠŸ: ${successCount} æ¡ï¼Œå¤±è´¥: ${errorCount} æ¡`;
                } else {
                    message = `åˆ é™¤å¤±è´¥ï¼Œæ‰€æœ‰ ${errorCount} æ¡è®°å½•éƒ½æœªèƒ½åˆ é™¤`;
                }
                
                alert(message);
                elements.batchDeleteConfirmModal.classList.remove('show');
                
                // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                switch(type) {
                    case 'users':
                        selectedUsers.clear();
                        break;
                    case 'friendships':
                        selectedFriendships.clear();
                        break;
                    case 'messages':
                        selectedMessages.clear();
                        break;
                }
                
                // åˆ·æ–°æ•°æ®
                loadStats();
                switch(type) {
                    case 'users':
                        loadUsersData();
                        loadAllUsers();
                        break;
                    case 'friendships':
                        loadFriendshipsData();
                        break;
                    case 'messages':
                        loadMessagesData();
                        break;
                }
                
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤é”™è¯¯:', error);
                alert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                elements.confirmBatchDelete.disabled = false;
                elements.confirmBatchDelete.textContent = 'ç¡®è®¤åˆ é™¤';
            }
        }
        
        // ç¡®è®¤åˆ é™¤é¡¹ç›®
        function confirmDeleteItem(type, id, name) {
            currentDeleteItem = { type, id };
            
            let message = '';
            switch(type) {
                case 'user':
                    message = `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${name}" å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥ç”¨æˆ·çš„å¥½å‹å…³ç³»å’Œæ¶ˆæ¯ã€‚`;
                    break;
                case 'friendship':
                    message = `ç¡®å®šè¦åˆ é™¤è¿™æ¡å¥½å‹å…³ç³»å—ï¼Ÿ`;
                    break;
                case 'message':
                    message = `ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ`;
                    break;
            }
            
            elements.deleteConfirmMessage.textContent = message;
            elements.deleteConfirmModal.classList.add('show');
        }
        
        // åŠ è½½å¥½å‹å…³ç³»æ•°æ®
        async function loadFriendshipsData() {
            if (!supabase) return;
            
            try {
                elements.friendshipsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <div>æ­£åœ¨åŠ è½½å¥½å‹å…³ç³»æ•°æ®...</div>
                            </div>
                        </td>
                    </tr>
                `;
                
                let query = supabase
                    .from('friends')
                    .select('*', { count: 'exact' });
                
                const searchTerm = elements.friendshipSearch.value.trim();
                if (searchTerm) {
                    const { data: users } = await supabase
                        .from('profiles')
                        .select('id')
                        .ilike('username', `%${searchTerm}%`);
                    
                    if (users && users.length > 0) {
                        const userIds = users.map(u => u.id);
                        query = query.in('user_id', userIds);
                    } else {
                        query = query.eq('user_id', 'no-match');
                    }
                }
                
                query = query.order(friendshipsSortState.field, { 
                    ascending: friendshipsSortState.order === 'asc' 
                });
                
                const from = (currentFriendshipsPage - 1) * itemsPerPage;
                const to = from + itemsPerPage - 1;
                query = query.range(from, to);
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                elements.friendshipsTableBody.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(friendship => {
                        const isChecked = selectedFriendships.has(friendship.id);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="checkbox-cell">
                                <input type="checkbox" class="friendship-checkbox" data-id="${friendship.id}" ${isChecked ? 'checked' : ''}>
                            </td>
                            <td>${getUserAvatar(friendship.user_id)}</td>
                            <td>${getUserAvatar(friendship.friend_id)}</td>
                            <td>${friendship.status || 'N/A'}</td>
                            <td>${formatDate(friendship.created_at)}</td>
                            <td>
                                <button class="action-btn delete" onclick="confirmDeleteItem('friendship', '${friendship.id}', 'å¥½å‹å…³ç³»')">åˆ é™¤</button>
                            </td>
                        `;
                        elements.friendshipsTableBody.appendChild(row);
                    });
                    
                    document.querySelectorAll('.friendship-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const friendshipId = this.getAttribute('data-id');
                            if (this.checked) {
                                selectedFriendships.add(friendshipId);
                            } else {
                                selectedFriendships.delete(friendshipId);
                            }
                            updateSelectedCount('friendships');
                        });
                    });
                } else {
                    elements.friendshipsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-data">æ²¡æœ‰æ‰¾åˆ°å¥½å‹å…³ç³»æ•°æ®</td>
                        </tr>
                    `;
                }
                
                updatePagination(elements.friendshipsPagination, currentFriendshipsPage, count, 'friendships');
                updateSelectAllCheckbox('friendships');
                
            } catch (error) {
                console.error('åŠ è½½å¥½å‹å…³ç³»æ•°æ®é”™è¯¯:', error);
                elements.friendshipsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">åŠ è½½å¥½å‹å…³ç³»æ•°æ®å¤±è´¥</td>
                    </tr>
                `;
            }
        }
        
        // åŠ è½½æ¶ˆæ¯æ•°æ®
        async function loadMessagesData() {
            if (!supabase) return;
            
            try {
                elements.messagesTableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <div>æ­£åœ¨åŠ è½½æ¶ˆæ¯æ•°æ®...</div>
                            </div>
                        </td>
                    </tr>
                `;
                
                let query = supabase
                    .from('private_messages')
                    .select('*', { count: 'exact' });
                
                const searchTerm = elements.messageSearch.value.trim();
                if (searchTerm) {
                    const { data: users } = await supabase
                        .from('profiles')
                        .select('id')
                        .ilike('username', `%${searchTerm}%`);
                    
                    if (users && users.length > 0) {
                        const userIds = users.map(u => u.id);
                        query = query.or(`sender_id.in.(${userIds.join(',')}),receiver_id.in.(${userIds.join(',')}),content.ilike.%${searchTerm}%`);
                    } else {
                        query = query.ilike('content', `%${searchTerm}%`);
                    }
                }
                
                query = query.order(messagesSortState.field, { 
                    ascending: messagesSortState.order === 'asc' 
                });
                
                const from = (currentMessagesPage - 1) * itemsPerPage;
                const to = from + itemsPerPage - 1;
                query = query.range(from, to);
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                elements.messagesTableBody.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(message => {
                        const isChecked = selectedMessages.has(message.id);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="checkbox-cell">
                                <input type="checkbox" class="message-checkbox" data-id="${message.id}" ${isChecked ? 'checked' : ''}>
                            </td>
                            <td>${getUserAvatar(message.sender_id)}</td>
                            <td class="message-direction">
                                <span class="arrow-icon">â†’</span>
                            </td>
                            <td>${getUserAvatar(message.receiver_id)}</td>
                            <td>
                                <div class="fixed-message">
                                    ${formatMessageContent(message.content)}
                                </div>
                            </td>
                            <td>${message.is_recalled ? 'æ˜¯' : 'å¦'}</td>
                            <td>${formatDate(message.created_at)}</td>
                            <td>
                                <button class="action-btn delete" onclick="confirmDeleteItem('message', '${message.id}', 'æ¶ˆæ¯')">åˆ é™¤</button>
                            </td>
                        `;
                        elements.messagesTableBody.appendChild(row);
                    });
                    
                    document.querySelectorAll('.message-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const messageId = this.getAttribute('data-id');
                            if (this.checked) {
                                selectedMessages.add(messageId);
                            } else {
                                selectedMessages.delete(messageId);
                            }
                            updateSelectedCount('messages');
                        });
                    });
                } else {
                    elements.messagesTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="no-data">æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯æ•°æ®</td>
                        </tr>
                    `;
                }
                
                updatePagination(elements.messagesPagination, currentMessagesPage, count, 'messages');
                updateSelectAllCheckbox('messages');
                
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯æ•°æ®é”™è¯¯:', error);
                elements.messagesTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">åŠ è½½æ¶ˆæ¯æ•°æ®å¤±è´¥</td>
                    </tr>
                `;
            }
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessageContent(content) {
            if (!content) return '';
            
            const imgRegex = /(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:\?[^\s]*)?)/gi;
            let processedContent = escapeHtml(content);
            
            const imgMatches = content.match(imgRegex);
            if (imgMatches && imgMatches.length === 1 && content.trim() === imgMatches[0]) {
                return `<div class="message-content"><img src="${content}" class="message-image" onerror="this.style.display='none'"></div>`;
            }
            
            const parts = processedContent.split(imgRegex);
            let result = '<div class="message-content">';
            
            for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 1) {
                    result += `<img src="${parts[i]}" class="message-image" onerror="this.style.display='none'">`;
                } else {
                    result += parts[i];
                }
            }
            
            result += '</div>';
            return result;
        }
        
        // åˆå§‹åŒ–ç½‘ç»œå›¾
        async function initializeNetworkGraph() {
            if (!supabase) return;
            
            try {
                elements.networkGraph.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div>æ­£åœ¨åŠ è½½å…³ç³»ç½‘ç»œå›¾...</div>
                    </div>
                `;
                
                const [usersResponse, friendshipsResponse] = await Promise.all([
                    supabase.from('profiles').select('id, username, friend_code, avatar_url, created_at'),
                    supabase.from('friends').select('user_id, friend_id, status, created_at')
                ]);
                
                if (usersResponse.error) throw usersResponse.error;
                if (friendshipsResponse.error) throw friendshipsResponse.error;
                
                const users = usersResponse.data;
                const friendships = friendshipsResponse.data;
                
                graphData = {
                    nodes: users.map(user => ({
                        id: user.id,
                        name: user.username,
                        friend_code: user.friend_code,
                        avatar_url: user.avatar_url,
                        created_at: user.created_at,
                        group: Math.floor(Math.random() * 10)
                    })),
                    links: friendships.map(friendship => ({
                        source: friendship.user_id,
                        target: friendship.friend_id,
                        status: friendship.status,
                        created_at: friendship.created_at
                    }))
                };
                
                calculateNodeDegrees();
                updateGraphStats();
                renderNetworkGraph();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–ç½‘ç»œå›¾é”™è¯¯:', error);
                elements.networkGraph.innerHTML = `
                    <div class="no-data">åŠ è½½å…³ç³»ç½‘ç»œå›¾å¤±è´¥</div>
                `;
            }
        }
        
        // è®¡ç®—èŠ‚ç‚¹åº¦æ•°
        function calculateNodeDegrees() {
            graphData.nodes.forEach(node => {
                node.degree = 0;
            });
            
            graphData.links.forEach(link => {
                const sourceNode = graphData.nodes.find(node => node.id === link.source);
                const targetNode = graphData.nodes.find(node => node.id === link.target);
                
                if (sourceNode) sourceNode.degree++;
                if (targetNode) targetNode.degree++;
            });
        }
        
        // æ›´æ–°å›¾è¡¨ç»Ÿè®¡
        function updateGraphStats() {
            elements.graphNodeCount.textContent = graphData.nodes.length;
            elements.graphLinkCount.textContent = graphData.links.length;
            
            const isolatedNodes = graphData.nodes.filter(node => node.degree === 0);
            elements.graphIsolatedCount.textContent = isolatedNodes.length;
            
            const largestComponentSize = calculateLargestComponent();
            elements.graphConnectedCount.textContent = largestComponentSize;
            
            updateInfoPanel();
        }
        
        // è®¡ç®—æœ€å¤§è¿æ¥ç»„ä»¶
        function calculateLargestComponent() {
            const visited = new Set();
            let maxSize = 0;
            
            graphData.nodes.forEach(node => {
                if (!visited.has(node.id)) {
                    const componentSize = bfs(node.id, visited);
                    maxSize = Math.max(maxSize, componentSize);
                }
            });
            
            return maxSize;
        }
        
        // å¹¿åº¦ä¼˜å…ˆæœç´¢
        function bfs(startId, visited) {
            const queue = [startId];
            visited.add(startId);
            let size = 0;
            
            while (queue.length > 0) {
                const currentId = queue.shift();
                size++;
                
                graphData.links.forEach(link => {
                    if (link.source === currentId && !visited.has(link.target)) {
                        visited.add(link.target);
                        queue.push(link.target);
                    } else if (link.target === currentId && !visited.has(link.source)) {
                        visited.add(link.source);
                        queue.push(link.source);
                    }
                });
            }
            
            return size;
        }
        
        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfoPanel() {
            elements.infoTotalUsers.textContent = graphData.nodes.length;
            elements.infoTotalRelationships.textContent = graphData.links.length;
            
            const n = graphData.nodes.length;
            const possibleLinks = n * (n - 1) / 2;
            const density = possibleLinks > 0 ? (graphData.links.length / possibleLinks).toFixed(4) : 0;
            elements.infoNetworkDensity.textContent = density;
            
            const degrees = graphData.nodes.map(node => node.degree);
            const averageDegree = degrees.length > 0 ? 
                (degrees.reduce((a, b) => a + b, 0) / degrees.length).toFixed(2) : 0;
            const maxDegree = degrees.length > 0 ? Math.max(...degrees) : 0;
            
            elements.infoAverageDegree.textContent = averageDegree;
            elements.infoMaxDegree.textContent = maxDegree;
        }
        
        // æ¸²æŸ“ç½‘ç»œå›¾
        function renderNetworkGraph() {
            elements.networkGraph.innerHTML = '';
            
            const width = elements.networkGraph.clientWidth;
            const height = elements.networkGraph.clientHeight;
            
            svg = d3.select('#networkGraph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    container.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            const container = svg.append('g');
            
            const link = container.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(graphData.links)
                .enter()
                .append('line')
                .attr('class', 'graph-link')
                .attr('stroke-width', 1);
            
            const nodeGroup = container.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('class', 'graph-node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            const clipPath = nodeGroup.append('clipPath')
                .attr('id', (d, i) => `clip-${i}`);
            
            clipPath.append('circle')
                .attr('r', d => elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15);
            
            nodeGroup.append('image')
                .attr('xlink:href', d => {
                    if (d.avatar_url && isValidUrl(d.avatar_url)) {
                        return d.avatar_url;
                    } else {
                        const canvas = document.createElement('canvas');
                        canvas.width = 30;
                        canvas.height = 30;
                        const ctx = canvas.getContext('2d');
                        const colors = ['#4a6ee0', '#4CAF50', '#FF9800', '#9C27B0', '#F44336', '#00BCD4'];
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        ctx.beginPath();
                        ctx.arc(15, 15, 15, 0, 2 * Math.PI);
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.fillStyle = 'white';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(d.name.charAt(0).toUpperCase(), 15, 15);
                        return canvas.toDataURL();
                    }
                })
                .attr('x', d => -(elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15))
                .attr('y', d => -(elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15))
                .attr('width', d => (elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(20 + d.degree * 3, 50) : 30))
                .attr('height', d => (elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(20 + d.degree * 3, 50) : 30))
                .attr('clip-path', (d, i) => `url(#clip-${i})`);
            
            nodeGroup.append('circle')
                .attr('r', d => elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15)
                .attr('fill', 'none')
                .attr('stroke', '#4a6ee0')
                .attr('stroke-width', 2);
            
            const label = container.append('g')
                .attr('class', 'labels')
                .selectAll('text')
                .data(graphData.nodes)
                .enter()
                .append('text')
                .attr('class', 'graph-label')
                .attr('dx', 12)
                .attr('dy', '.35em')
                .text(d => d.name)
                .style('display', elements.labelFilter.value === 'all' ? 'block' : 'none');
            
            tooltip = d3.select('body')
                .append('div')
                .attr('class', 'graph-tooltip')
                .style('opacity', 0);
            
            nodeGroup.on('mouseover', function(event, d) {
                nodeGroup.classed('highlighted', n => n.id === d.id);
                link.classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
                
                tooltip.transition()
                    .duration(200)
                    .style('opacity', .9);
                tooltip.html(`
                    <div><strong>${d.name}</strong></div>
                    <div>å¥½å‹ç : ${d.friend_code || 'æ— '}</div>
                    <div>å¥½å‹æ•°: ${d.degree}</div>
                    <div>æ³¨å†Œæ—¶é—´: ${formatDate(d.created_at)}</div>
                `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mouseout', function() {
                nodeGroup.classed('highlighted', false);
                link.classed('highlighted', false);
                
                tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            });
            
            nodeGroup.on('click', function(event, d) {
                console.log('ç‚¹å‡»èŠ‚ç‚¹:', d);
            });
            
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => (elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15) + 5))
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1));
            
            simulation.on('tick', () => {
                link
                    .attr('x1', d => Math.max(10, Math.min(width - 10, d.source.x)))
                    .attr('y1', d => Math.max(10, Math.min(height - 10, d.source.y)))
                    .attr('x2', d => Math.max(10, Math.min(width - 10, d.target.x)))
                    .attr('y2', d => Math.max(10, Math.min(height - 10, d.target.y)));
                
                nodeGroup
                    .attr('transform', d => `translate(${Math.max(10, Math.min(width - 10, d.x))}, ${Math.max(10, Math.min(height - 10, d.y))})`);
                
                label
                    .attr('x', d => Math.max(10, Math.min(width - 10, d.x)))
                    .attr('y', d => Math.max(10, Math.min(height - 10, d.y)));
            });
            
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = Math.max(10, Math.min(width - 10, event.x));
                d.fy = Math.max(10, Math.min(height - 10, event.y));
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }
        
        // è®¾ç½®å›¾è¡¨è¿‡æ»¤å™¨
        function setupGraphFilters() {
            elements.nodeSizeFilter.addEventListener('change', updateNodeSizes);
            elements.layoutFilter.addEventListener('change', updateLayout);
            elements.labelFilter.addEventListener('change', updateLabels);
        }
        
        // æ›´æ–°èŠ‚ç‚¹å¤§å°
        function updateNodeSizes() {
            if (!svg) return;
            
            d3.selectAll('.graph-node clipPath circle')
                .attr('r', d => elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15);
            
            d3.selectAll('.graph-node image')
                .attr('x', d => -(elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15))
                .attr('y', d => -(elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15))
                .attr('width', d => (elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(20 + d.degree * 3, 50) : 30))
                .attr('height', d => (elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(20 + d.degree * 3, 50) : 30));
            
            d3.selectAll('.graph-node circle')
                .attr('r', d => elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15);
            
            if (simulation) {
                simulation.force('collision', d3.forceCollide().radius(d => (elements.nodeSizeFilter.value === 'degree' ? 
                    Math.min(10 + d.degree * 1.5, 25) : 15) + 5))
                    .alpha(0.3)
                    .restart();
            }
        }
        
        // æ›´æ–°å¸ƒå±€
        function updateLayout() {
            if (!simulation) return;
            
            switch(elements.layoutFilter.value) {
                case 'force':
                    simulation
                        .force('charge', d3.forceManyBody().strength(-300))
                        .force('center', d3.forceCenter(elements.networkGraph.clientWidth / 2, elements.networkGraph.clientHeight / 2))
                        .alpha(0.3)
                        .restart();
                    break;
                case 'radial':
                    simulation
                        .force('charge', d3.forceManyBody().strength(-100))
                        .force('center', d3.forceRadial(200, elements.networkGraph.clientWidth / 2, elements.networkGraph.clientHeight / 2))
                        .alpha(0.3)
                        .restart();
                    break;
                case 'circular':
                    const radius = Math.min(elements.networkGraph.clientWidth, elements.networkGraph.clientHeight) / 3;
                    const angle = 2 * Math.PI / graphData.nodes.length;
                    
                    graphData.nodes.forEach((node, i) => {
                        node.fx = elements.networkGraph.clientWidth / 2 + radius * Math.cos(i * angle);
                        node.fy = elements.networkGraph.clientHeight / 2 + radius * Math.sin(i * angle);
                    });
                    
                    simulation.alpha(0.3).restart();
                    break;
            }
        }
        
        // æ›´æ–°æ ‡ç­¾
        function updateLabels() {
            if (!svg) return;
            
            switch(elements.labelFilter.value) {
                case 'all':
                    d3.selectAll('.graph-label').style('display', 'block');
                    break;
                case 'selected':
                    d3.selectAll('.graph-label').style('display', 'none');
                    break;
                case 'none':
                    d3.selectAll('.graph-label').style('display', 'none');
                    break;
            }
        }
        
        // æ ¹æ®æœç´¢è¿‡æ»¤å›¾è¡¨
        function filterGraphBySearch() {
            const searchTerm = elements.graphSearch.value.trim().toLowerCase();
            
            if (!searchTerm) {
                d3.selectAll('.graph-node').style('opacity', 1);
                d3.selectAll('.graph-link').style('opacity', 0.6);
                d3.selectAll('.graph-label').style('opacity', 1);
                return;
            }
            
            d3.selectAll('.graph-node').style('opacity', function(d) {
                return d.name.toLowerCase().includes(searchTerm) ? 1 : 0.1;
            });
            
            d3.selectAll('.graph-label').style('opacity', function(d) {
                return d.name.toLowerCase().includes(searchTerm) ? 1 : 0.1;
            });
            
            d3.selectAll('.graph-link').style('opacity', function(d) {
                return (
                    d.source.name.toLowerCase().includes(searchTerm) ||
                    d.target.name.toLowerCase().includes(searchTerm)
                ) ? 1 : 0.1;
            });
        }
        
        // åˆ‡æ¢ä¿¡æ¯é¢æ¿å¯è§æ€§
        function toggleInfoPanelVisibility() {
            if (isInfoPanelCollapsed) {
                elements.infoPanelContent.style.display = 'block';
                elements.toggleInfoPanel.textContent = 'æŠ˜å ';
                isInfoPanelCollapsed = false;
            } else {
                elements.infoPanelContent.style.display = 'none';
                elements.toggleInfoPanel.textContent = 'å±•å¼€';
                isInfoPanelCollapsed = true;
            }
        }
        
        // æ›´æ–°åˆ†é¡µ
        function updatePagination(paginationElement, currentPage, totalCount, type) {
            if (!totalCount || totalCount <= itemsPerPage) {
                paginationElement.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(totalCount / itemsPerPage);
            let paginationHTML = '';
            
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage('${type}', ${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage('${type}', ${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span>...</span>';
                }
            }
            
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage('${type}', ${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }
            
            paginationElement.innerHTML = paginationHTML;
        }
        
        // æ›´æ”¹é¡µé¢
        function changePage(type, page) {
            switch(type) {
                case 'users':
                    currentUsersPage = page;
                    loadUsersData();
                    break;
                case 'friendships':
                    currentFriendshipsPage = page;
                    loadFriendshipsData();
                    break;
                case 'messages':
                    currentMessagesPage = page;
                    loadMessagesData();
                    break;
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
        
        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // å‘é€é€šçŸ¥ç›¸å…³å‡½æ•°
        function openSendNotificationModal() {
            if (!isOfficialLoggedIn) {
                alert('è¯·å…ˆç™»å½•å®˜æ–¹è´¦å·');
                return;
            }
            
            updateNotificationStats();
            elements.sendNotificationModal.classList.add('show');
            elements.notificationContent.value = '';
            
            // åŠ è½½é€šçŸ¥ç”¨æˆ·åˆ—è¡¨
            loadNotificationUsers();
        }
        
        function closeSendNotificationModal() {
            elements.sendNotificationModal.classList.remove('show');
        }
        
        function updateNotificationStats() {
            const sendTo = document.querySelector('input[name="sendTo"]:checked').value;
            
            // æ˜¾ç¤ºæˆ–éšè—è‡ªå®šä¹‰ç”¨æˆ·é€‰æ‹©åŒºåŸŸ
            if (sendTo === 'custom') {
                elements.customUserSelection.style.display = 'block';
            } else {
                elements.customUserSelection.style.display = 'none';
            }
            
            let recipientCount = 0;
            
            if (sendTo === 'selected') {
                recipientCount = selectedUsers.size;
                elements.recipientCount.textContent = recipientCount;
                elements.selectedUsersCount.textContent = selectedUsers.size;
            } else if (sendTo === 'all') {
                // è·å–æ€»ç”¨æˆ·æ•°
                const totalUsers = parseInt(elements.totalUsers.textContent) || 0;
                recipientCount = totalUsers;
                elements.recipientCount.textContent = recipientCount;
                elements.selectedUsersCount.textContent = selectedUsers.size;
            } else if (sendTo === 'custom') {
                recipientCount = notificationSelectedUsers.size;
                elements.recipientCount.textContent = recipientCount;
                elements.selectedUsersCount.textContent = selectedUsers.size;
                elements.customSelectedCount.textContent = `å·²é€‰æ‹© ${recipientCount} ä¸ªç”¨æˆ·`;
            }
        }
        
        // åŠ è½½é€šçŸ¥ç”¨æˆ·åˆ—è¡¨
        async function loadNotificationUsers() {
            if (!supabase) return;
            
            try {
                elements.notificationUsersList.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div>æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨...</div>
                    </div>
                `;
                
                let query = supabase
                    .from('profiles')
                    .select('id, username, friend_code, avatar_url, created_at');
                
                const searchTerm = elements.notificationUserSearch.value.trim();
                if (searchTerm) {
                    query = query.ilike('username', `%${searchTerm}%`);
                }
                
                query = query.order('created_at', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                elements.notificationUsersList.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(user => {
                        const isChecked = notificationSelectedUsers.has(user.id);
                        const username = user.username || `ç”¨æˆ·(${user.id.substring(0, 8)}...)`;
                        const initial = username.charAt(0).toUpperCase();
                        const avatarUrl = user.avatar_url;
                        
                        let avatarHtml = '';
                        if (avatarUrl && isValidUrl(avatarUrl)) {
                            avatarHtml = `
                                <img src="${avatarUrl}" class="user-avatar-img" alt="${username}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                <div class="user-avatar" style="display: none">${initial}</div>
                            `;
                        } else {
                            avatarHtml = `<div class="user-avatar">${initial}</div>`;
                        }
                        
                        const userItem = document.createElement('div');
                        userItem.className = `notification-user-item ${isChecked ? 'selected' : ''}`;
                        userItem.innerHTML = `
                            <input type="checkbox" class="notification-user-checkbox" data-id="${user.id}" ${isChecked ? 'checked' : ''}>
                            <div class="user-info">
                                ${avatarHtml}
                                ${username}
                            </div>
                        `;
                        
                        elements.notificationUsersList.appendChild(userItem);
                        
                        // æ·»åŠ å¤é€‰æ¡†äº‹ä»¶ç›‘å¬
                        const checkbox = userItem.querySelector('.notification-user-checkbox');
                        checkbox.addEventListener('change', function() {
                            const userId = this.getAttribute('data-id');
                            if (this.checked) {
                                notificationSelectedUsers.add(userId);
                                userItem.classList.add('selected');
                            } else {
                                notificationSelectedUsers.delete(userId);
                                userItem.classList.remove('selected');
                            }
                            updateNotificationStats();
                        });
                    });
                } else {
                    elements.notificationUsersList.innerHTML = `
                        <div class="no-data">æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·</div>
                    `;
                }
                
            } catch (error) {
                console.error('åŠ è½½é€šçŸ¥ç”¨æˆ·åˆ—è¡¨é”™è¯¯:', error);
                elements.notificationUsersList.innerHTML = `
                    <div class="no-data">åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥</div>
                `;
            }
        }
        
        // å…¨é€‰é€šçŸ¥ç”¨æˆ·
        function selectAllNotificationUsers() {
            document.querySelectorAll('.notification-user-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                const userId = checkbox.getAttribute('data-id');
                notificationSelectedUsers.add(userId);
                checkbox.parentElement.classList.add('selected');
            });
            updateNotificationStats();
        }
        
        // å–æ¶ˆé€‰æ‹©æ‰€æœ‰é€šçŸ¥ç”¨æˆ·
        function selectNoneNotificationUsers() {
            document.querySelectorAll('.notification-user-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                const userId = checkbox.getAttribute('data-id');
                notificationSelectedUsers.delete(userId);
                checkbox.parentElement.classList.remove('selected');
            });
            updateNotificationStats();
        }
        
        async function sendNotifications() {
            if (!isOfficialLoggedIn) {
                alert('è¯·å…ˆç™»å½•å®˜æ–¹è´¦å·');
                return;
            }
            
            const content = elements.notificationContent.value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥é€šçŸ¥å†…å®¹');
                return;
            }
            
            const sendTo = document.querySelector('input[name="sendTo"]:checked').value;
            
            try {
                let userIds = [];
                
                if (sendTo === 'selected') {
                    userIds = Array.from(selectedUsers);
                } else if (sendTo === 'all') {
                    // è·å–æ‰€æœ‰ç”¨æˆ·ID
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('id');
                    
                    if (error) throw error;
                    
                    userIds = data.map(user => user.id);
                } else if (sendTo === 'custom') {
                    userIds = Array.from(notificationSelectedUsers);
                }
                
                if (userIds.length === 0) {
                    alert('æ²¡æœ‰å¯å‘é€çš„ç”¨æˆ·');
                    return;
                }
                
                // ç¡®è®¤å‘é€
                const confirmSend = confirm(`ç¡®å®šè¦å‘ ${userIds.length} ä¸ªç”¨æˆ·å‘é€é€šçŸ¥å—ï¼Ÿ`);
                if (!confirmSend) return;
                
                elements.confirmSendNotification.disabled = true;
                elements.confirmSendNotification.textContent = 'å‘é€ä¸­...';
                
                // æ‰¹é‡å‘é€æ¶ˆæ¯
                const messages = userIds.map(userId => ({
                    sender_id: officialSession.id,
                    receiver_id: userId,
                    content: content,
                    is_recalled: false,
                    created_at: new Date().toISOString()
                }));
                
                // åˆ†æ‰¹å‘é€ä»¥é¿å…è¶…é™
                const batchSize = 50;
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < messages.length; i += batchSize) {
                    const batch = messages.slice(i, i + batchSize);
                    
                    const { error } = await supabase
                        .from('private_messages')
                        .insert(batch);
                    
                    if (error) {
                        console.error('æ‰¹é‡å‘é€æ¶ˆæ¯é”™è¯¯:', error);
                        errorCount += batch.length;
                    } else {
                        successCount += batch.length;
                    }
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = Math.min(i + batchSize, messages.length);
                    elements.confirmSendNotification.textContent = `å‘é€ä¸­... ${progress}/${messages.length}`;
                }
                
                alert(`é€šçŸ¥å‘é€å®Œæˆï¼\næˆåŠŸ: ${successCount} æ¡\nå¤±è´¥: ${errorCount} æ¡`);
                
                closeSendNotificationModal();
                
            } catch (error) {
                console.error('å‘é€é€šçŸ¥é”™è¯¯:', error);
                alert('å‘é€é€šçŸ¥å¤±è´¥: ' + error.message);
            } finally {
                elements.confirmSendNotification.disabled = false;
                elements.confirmSendNotification.textContent = 'å‘é€é€šçŸ¥';
            }
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
